#Created Date: Friday, January 9th 2026, 7:02:18 pm
#Author: Nicolas P. Alves

# This code is free to use, modify, and distribute for any purpose,
# provided that proper credit is given to the original author.


# Importing necessary libraries
import numpy as np
import pandas as pd
import matplotlib as mpl
import pylustrator
pylustrator.start()
import matplotlib.pyplot as plt
from mpl_toolkits.axes_grid1.inset_locator import inset_axes

# Importing custom functions from other files
from Metagraph_plot import plot_metagraph_with_umap_clusters


# Load precomputed data
data = np.load("Data/plot_series_data.npz", allow_pickle=True)
files_a = [rf"Data/QML_286_plot/P_subplot1_line{i}.csv" for i in range(1, 6)]
files_b = [rf"Data/QML_286_plot/P_subplot2_line{i}.csv" for i in range(1, 6)]

# Extract and set variables
series = data["series"]
cluster_time_indices_2d = data["cluster_time_indices_2d"]
labels_2d = data["labels_2d"]
K = int(data["K"])
window_size = 80
dfs_a = [pd.read_csv(f, header=None) for f in files_a]
dfs_b = [pd.read_csv(f, header=None) for f in files_b]

# Plot settings

# Select font and style parameters
text_size = 17
plt.rcParams.update({
    'font.family': 'sans-serif',
    'font.sans-serif': 'Helvetica',
    'font.size': text_size,
})
plt.rcParams['axes.linewidth'] = 1.2

# Define cluster and line colors 
cmap = plt.cm.inferno
cluster_colors = [cmap(0.15), cmap(0.50), cmap(0.85)]
colors = [cmap(0.85), cmap(0.50), cmap(0.15)] + ['#3A6B35', '#A3BFA3']
line_styles = ['dashed', 'dashed','dashed', 'solid']

# Create the figure and axes
scaling_factor = 2.5
fig = plt.figure(figsize=(scaling_factor*3.5, scaling_factor*3.2), layout='constrained')

# Define grid specification and span of the subplots
gs = fig.add_gridspec(4,2)
ax1 = fig.add_subplot(gs[:2, 0])        # Metagraph
ax2 = fig.add_subplot(gs[1, 1])         # Time series
ax3 = fig.add_subplot(gs[0, 1])         # Pie chart for time series
ax4 = fig.add_subplot(gs[2:, 0])        # P(x)
ax5 = fig.add_subplot(gs[2:, 1])        # f(ε)


# Plot a) Metagraph with UMAP clusters
res_meta = plot_metagraph_with_umap_clusters(
    series=series,
    labels_windows=labels_2d,
    window_size=window_size,
    colors=cluster_colors,
    nivel="auto",
    seed=42,
    ax=ax1)

ax1.text(-0.12, 1.02, "a", transform=ax1.transAxes,
             ha='right', va='bottom', fontsize=text_size+3, fontweight='bold')


# Plot b) Time series with cluster coloring
for k in range(K):
    idx = cluster_time_indices_2d[k]
    if idx.size:
        ax2.scatter(idx/10000, series[idx], s=0.8, color=cluster_colors[k], alpha=0.95)

ax2.set_xlabel(r'$t~(\times 10^4~\text{arb. units})$', labelpad=10)
ax2.set_ylabel(r'$\varepsilon(t)$', labelpad=10)
ax2.tick_params(axis='both', which='both', direction='in', labelsize=text_size)
ax2.text(-0.12, 1.02, "b", transform=ax2.transAxes,
             ha='right', va='bottom', fontsize=text_size+3, fontweight='bold')
ax2.set_xlim(0,15)


# Pie chart inset for cluster proportions
M_k = np.bincount(labels_2d, minlength=K)
labels_pie = [f'Cluster {i+1}' for i in range(K)]
ax3.pie(M_k, labels=labels_pie, startangle=90, counterclock=False, colors=cluster_colors, labeldistance=1.2, textprops={'fontsize' : text_size-2})
ax3.set_aspect('equal', 'box')


# Plot c): P(x)
for i, df in enumerate(dfs_b):
    if i < 4:
        ax4.plot(df.iloc[:, 0], df.iloc[:, 1],
                     lw=2.2, color=colors[i], ls=line_styles[i], zorder=5-i)
    else:
        ax4.scatter(df.iloc[:, 0], df.iloc[:, 1],
                        linewidth=1.7, marker='o', facecolors='none',
                        color=colors[i], s=30, zorder=0)

ax4.set_ylabel(r"$P(x)$", labelpad=10)
ax4.set_xlabel(r"$x$", labelpad=10)
ax4.set_yscale('log')
ax4.set_xlim(-6,6)
ax4.set_ylim(5e-4,3e0)
ax4.tick_params(axis='both', which='both', top=True, right=True, direction='in', labelsize=text_size)
ax4.text(-0.12, 1.02, "c", transform=ax4.transAxes,
             ha='right', va='bottom', fontsize=text_size+3, fontweight='bold')


# Plot d) f(ε) 
for i, df in enumerate(dfs_a):
    if i < 4:
        ax5.plot(df.iloc[:, 0], df.iloc[:, 1],
                     lw=2.2, color=colors[i], ls=line_styles[i], zorder=5-i)
    else:
        ax5.scatter(df.iloc[:, 0], df.iloc[:, 1],
                        linewidth=1.7, marker='o', facecolors='none',
                        color=colors[i], s=35, zorder=0)

ax5.set_ylabel(r"$f(\epsilon)$", labelpad=12)
ax5.set_xlabel(r"$\epsilon$", labelpad=12)
ax5.set_xscale('log')
ax5.set_yscale('log')
ax5.set_xlim(1e-2,1.2e1)
ax5.set_ylim(5e-4,2e1)
ax5.tick_params(axis='both', which='both', direction='in', top=True, right=True, labelsize=text_size)
ax5.text(-0.12, 1.02, "d", transform=ax5.transAxes,
             ha='right', va='bottom', fontsize=text_size+3, fontweight='bold')


# Adjust layout with positions
plt.figure(1).ax_dict = {ax.get_label(): ax for ax in plt.figure(1).axes}
plt.figure(1).axes[0].set(position=[0.1106, 0.4929, 0.3795, 0.4105])
plt.figure(1).axes[2].set(position=[0.7339, 0.7801, 0.12, 0.1304])

# Save and show the final figure
#% start: automatic generated code from pylustrator
plt.figure(1).ax_dict = {ax.get_label(): ax for ax in plt.figure(1).axes}
import matplotlib as mpl
getattr(plt.figure(1), '_pylustrator_init', lambda: ...)()
plt.figure(1).axes[0].texts[0].set(position=(-0.12, 0.6987))
#% end: automatic generated code from pylustrator
plt.show()